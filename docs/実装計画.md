# IMPLEMENTATION_PLAN.md — 実装計画書 (MVP)

## 0. 前提 / ゴール

- SPEC.md の受け入れ基準をすべて満たすこと
- Next.js + NestJS + PostgreSQL + Docker 構成
- Asia/Tokyo タイムゾーン
- mono-repo 構成

---

## 1. マイルストーン（WBS）

- M1: 基盤整備
- M2: データ層 & API骨格
- M3: プロジェクト管理 + 共通設定(休日) + バックアップ/復元
- M4: Issue CRUD + コメント編集/削除 + 履歴 + 画像アップロード&サムネイル
- M5: WBS ツリー + 並び替え
- M6: ガント（範囲制限・依存線矢印・終了日マイルストーン）
- M7: E2E・受け入れ試験・クリーンアップJob検証

---

## 2. ディレクトリ構成

- backend/modules/settings （共通休日設定API）
- backend/modules/uploads/thumbs （サムネイル生成）
- backend/jobs/cleanup （論理削除データの物理削除Job）

---

## 3. Prisma スキーマ（抜粋）

- `GlobalSettings`: 固定休日（土日ON/OFF）, holidayDates[]
- `Project`: name に @unique、休日関連フィールド削除
- `Issue`: deletedAt を追加
- `Comment`: edited フラグを追加

---

## 4. API

- GET/PUT `/settings/holidays`（共通休日）
- PATCH `/comments/:id`（コメント編集）
- POST `/backup/export`（削除済みを除外）

---

## 5. 実装タスク詳細

- コメント編集UI: 「編集済み」表示
- コメント通知WS: 本文のみ送信
- サムネイル生成: Sharp などで実装
- 論理削除30日超: CleanupJob で物理削除（DB+画像）

---

## 6. テスト計画

- コメント編集APIテスト
- 設定変更WSテスト（休日変更リアルタイム反映）
- クリーンアップJobテスト（論理削除30日超）
- ガント範囲E2E（期間外スクロール不可）
- 依存線矢印表示確認

---

## 7. 開発フロー / CI/CD

- GitHub Actions: lint/test/build/E2E
- デプロイ前: prisma migrate deploy
- ログローテーション: winston + daily-rotate-file or logrotate
- CRON: Nest Schedule で CleanupJob 毎日実行

---

## 8. リスクと対応策

- コメント編集による履歴増加 → 編集済みフラグのみで軽量化
- 共通休日設定の影響範囲 → 全プロジェクト同時更新で整合性確保
- クリーンアップJobの誤削除 → deletedAt + 30日判定で安全性担保

---

## 9. スケジュール例

- Week1–2: 基盤 + データ層
- Week3: プロジェクト管理 + 共通設定 + バックアップ
- Week4–5: Issue + コメント + 履歴 + 画像
- Week6: WBS
- Week7–8: ガント
- Week9: テスト・CleanupJob検証・仕上げ

---

## 10. 将来拡張メモ

- プロジェクトごとの休日設定
- コメント本文のバージョン管理
- 任意カラーラベル
- リアルタイムプレビューMarkdown
- RBAC認証
