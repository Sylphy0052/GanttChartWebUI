# SPEC.md — Issue/WBS/Gantt Webアプリ 仕様書 (MVP 完成版)

## 1. 目的 / スコープ

- Backlog風の **Issue管理** を中心に、**WBS（階層）** と **ガントチャート** による計画・進捗可視化を実現する。
- 本MVPで提供する主機能：
  - プロジェクトの登録・閲覧・更新・削除（CRUD, 論理削除）
  - プロジェクト配下のIssue（タスク）のCRUD
  - Issueを基にしたWBS表示・編集、ガント表示・編集
  - 依存関係（FSのみ）、コメント、修正履歴閲覧
  - プロジェクト単位のバックアップ/復元（エクスポート/インポート、画像込み）

---

## 2. 用語

- **Issue**: タスク。親子関係を持つ（WBS）。
- **WBS**: Issueの階層ツリー。
- **依存関係**: タスク間の順序制約。MVPは **FS(Finish-to-Start)** のみ。
- **リソースビュー**: 担当者単位でタスクを俯瞰。

---

## 3. 権限モデル

- **Viewer（パスワード未入力）**
  - プロジェクト・Issueを閲覧できる  
  - コメント投稿・編集可能  
- **Editor（パスワード入力済み）**
  - 上記に加え、Issue/WBS/ガント/依存関係/プロジェクト設定を編集可能  
  - コメント削除可能  

---

## 4. 画面一覧

- プロジェクト一覧
- メイン画面（WBS・Issueリスト・ガント）
- Issue詳細パネル（コメント・履歴タブあり）
- コメントパネル（投稿/編集/削除）
- 修正履歴パネル
- バックアップ/復元画面
- 設定画面（共通休日設定・共有PW）
- 削除/インポート確認ダイアログ（1段階確認）
- Markdownエディタ（入力 / プレビュー切替タブ）
- 画像サムネイル表示（クリックで原寸モーダル）

---

## 5. データモデル（PostgreSQL）

- **Project**
  - id, name (unique), description_md, shared_password_hash, created_at, updated_at, is_deleted
- **GlobalSettings**
  - 固定休日（土日 ON/OFF）, holidayDates[]
- **Issue**
  - id, project_id, parent_id, title, description_md, assignee, status,  
    start_date, end_date, progress_pct, effort_hours, is_blocked, sort_order, labels[],  
    version, is_deleted, deleted_at, created_at, updated_at
- **Dependency**
  - id, project_id, predecessor_issue_id, successor_issue_id, type (FS)
- **Comment**
  - id, issue_id, author, body_md, created_at, edited (bool)
- **ChangeLog**
  - id, entity_type, entity_id, diff_json, user_hint, created_at
- **ImagePath**
  - id, issue_id, path (UUIDファイル名), created_at

---

## 6. 画像

- アップロード: PNG/JPG/GIF, 最大5MB, 1Issue/コメントにつき最大3枚
- ファイル名: UUIDで生成
- 保存先: `/uploads/{projectId}/{issueId}/{uuid}.{ext}`
- サムネイル生成（200px幅程度）
- Issue削除時に画像は物理削除
- バックアップZIPには削除済みデータは含めない

---

## 7. ガント仕様

- 表示範囲: プロジェクト開始日〜終了日のみ
- ズームレベル: 日/週/月
- バー編集（伸縮/横移動）
- マイルストーン: 開始=終了日のIssue → 終了日の位置にダイヤ表示
- 依存関係: FSのみ、矢印付き折れ線、循環禁止
- 休日: 背景を灰色表示
- 色分け: open=灰, in_progress=青, done=緑, blocked=赤
- 進捗: バー内部を塗り分け
- ツールチップ: 開始/終了/担当/工数/ラベル

---

## 8. コメント/履歴

- コメント: Markdown入力（画像可）、Viewerも投稿/編集可、削除はEditorのみ
- 編集済みは「(編集済み)」表示
- 削除は完全削除（本文残さない）
- ChangeLog: 無期限保持、削除/編集イベント記録
- コメント通知: 本文のみ送信（ユーザー名はクライアント側APIで取得）

---

## 9. バックアップ/復元

- エクスポート: JSON＋画像ファイルをZIP化（削除済みは含めない）
- インポート: ZIPをアップロードし復元
- ZIP最大サイズ: 100MB
- 論理削除: 30日後に物理削除（DB＋画像）

---

## 10. 操作ルール

- Undo/Redo: ボタン＋ショートカット(Ctrl+Z/Ctrl+Y)、最大50件
- Undo/Redo対象外: バックアップ/復元、設定変更、コメント投稿/削除
- 並び順: D&D＋自動ソート（開始日順/終了日順/ラベル順）

---

## 11. ラベル

- 自由入力（その場で新規作成可能）
- 固定色パレット（青/緑/赤/黄/紫/灰）

---

## 12. Issueステータス

- open / in_progress / done / blocked（4種類固定）

---

## 13. 進捗率

- 数値入力＋スライダー両方
- 親Issueは子Issueから加重平均で自動集計
- ユーザーが手動上書き可能（手動設定時は自動集計停止）

---

## 14. プロジェクト説明文

- Markdown対応（リンク可）
- 画像挿入不可
- 一覧/詳細でレンダリング表示

---

## 15. 共有パスワード

- 即時反映、旧パスワードは即時無効化
- 設定変更はWSで通知、既存セッションは再認証が必要

---

## 16. ログ/監視

- 出力レベル: info / warn / error
- 保存先: ファイル
- ローテーション: 日次 (`app-YYYY-MM-DD.log`) + サイズ上限10MB
- 保持: 最大30日または世代10
