# Week 2 実装プラン: WBS階層表示 + ガント初期表示

**策定日時**: 2025-09-05 02:16:17  
**策定者**: Claude Code  
**対象フェーズ**: Week 2 - WBS階層表示 + ガント初期表示  
**前提**: Week 1 (Issue CRUD + 基本認証) 完了済み

## 1. プラン概要

### 1.1 実装目標
- **WBS（Work Breakdown Structure）階層表示**: Issueの親子関係を視覚的に表示する階層ツリー
- **ガントチャート初期表示**: SVG基盤のガントチャートでIssueのタイムライン表示
- **D3.jsスケール統合**: 時間軸とスケールの適切な管理
- **基本ナビゲーション**: WBS・ガント・Issue管理間の画面遷移

### 1.2 成功基準
✅ **機能要件**
- WBSツリーでの階層表示（展開/折りたたみ対応）
- ガントチャートでの基本タイムライン表示
- Issue詳細とWBS/ガントの連携表示
- 1,000件Issueでの表示性能 < 1.5秒

✅ **非機能要件**
- TypeScript型安全性の維持
- レスポンシブデザイン対応
- アクセシビリティ基本対応
- エラーハンドリング適切実装

## 2. 詳細実装タスク（優先度順）

### 2.1 Phase 1: 基盤・型定義（高優先度）
**期間**: 実装開始〜20%完了

1. **型定義の拡張**
   - `apps/web/src/types/wbs.ts` - WBS階層構造型
   - `apps/web/src/types/gantt.ts` - ガント表示用型
   - 既存Issue型の拡張（階層関係フィールド）

2. **D3.js依存関係追加**
   - `d3-scale`, `d3-time`, `d3-array` パッケージ追加
   - TypeScript型定義 `@types/d3-*` 追加

3. **ユーティリティ関数**
   - `apps/web/src/lib/wbs-utils.ts` - 階層データ操作
   - `apps/web/src/lib/gantt-utils.ts` - D3スケール・時間計算

### 2.2 Phase 2: API拡張（高優先度）
**期間**: 20%〜40%完了

1. **Issues API拡張**
   - `apps/api/src/issues/dto/wbs-tree.dto.ts` - WBS階層レスポンス用DTO
   - `apps/api/src/issues/issues.service.ts` 拡張
     - `getIssueTree()` - 階層構造取得
     - `getGanttData()` - ガント表示用データ
   - `apps/api/src/issues/issues.controller.ts` 拡張
     - `GET /issues/tree` - WBSツリー取得エンドポイント
     - `GET /issues/gantt` - ガント用データエンドポイント

2. **パフォーマンス最適化**
   - インデックス最適化（parent_issue_id, start_date, due_date）
   - N+1問題対策（Prisma include活用）

### 2.3 Phase 3: WBSコンポーネント（高優先度）
**期間**: 40%〜60%完了

1. **WBS階層表示コンポーネント**
   - `apps/web/src/components/wbs/WBSTree.tsx` - メインWBSツリー
   - `apps/web/src/components/wbs/WBSNode.tsx` - 個別ノード
   - `apps/web/src/components/wbs/WBSActions.tsx` - ノード操作UI

2. **状態管理**
   - `apps/web/src/stores/wbs.store.ts` - WBS専用Zustandストア
   - 展開/折りたたみ状態管理
   - 選択ノード管理

3. **WBSページ**
   - `apps/web/src/app/wbs/page.tsx` - WBSメインページ
   - `apps/web/src/app/wbs/layout.tsx` - WBS専用レイアウト

### 2.4 Phase 4: ガントチャート基盤（高優先度）
**期間**: 60%〜80%完了

1. **ガントチャートコンポーネント**
   - `apps/web/src/components/gantt/GanttChart.tsx` - メインコンテナ
   - `apps/web/src/components/gantt/GanttTimeline.tsx` - 時間軸ヘッダー
   - `apps/web/src/components/gantt/GanttGrid.tsx` - グリッド表示
   - `apps/web/src/components/gantt/GanttBar.tsx` - 個別タスクバー

2. **D3スケール実装**
   - 時間軸スケール（日/週/月表示切替）
   - 動的ズーム対応
   - 今日線（Todayライン）表示

3. **状態管理**
   - `apps/web/src/stores/gantt.store.ts` - ガント専用ストア
   - 表示期間管理
   - ズームレベル管理

### 2.5 Phase 5: 統合・最適化（中優先度）
**期間**: 80%〜100%完了

1. **ガントページ**
   - `apps/web/src/app/gantt/page.tsx` - ガントメインページ
   - `apps/web/src/app/gantt/layout.tsx` - ガント専用レイアウト

2. **ナビゲーション統合**
   - メインナビゲーション更新（WBS・ガントメニュー追加）
   - パンくずナビ実装

3. **パフォーマンス最適化**
   - React.memo適用
   - 仮想スクロール実装（react-virtualized）
   - 差分レンダリング最適化

## 3. ファイル変更計画

### 3.1 新規作成ファイル（20件）

#### Backend API
```
apps/api/src/issues/dto/wbs-tree.dto.ts          # WBS階層レスポンスDTO
```

#### Frontend Core
```
apps/web/src/types/wbs.ts                        # WBS型定義
apps/web/src/types/gantt.ts                      # ガント型定義
apps/web/src/lib/wbs-utils.ts                    # WBS操作ユーティリティ
apps/web/src/lib/gantt-utils.ts                  # ガント・D3ユーティリティ
```

#### WBS Components
```
apps/web/src/components/wbs/WBSTree.tsx          # WBSツリーメイン
apps/web/src/components/wbs/WBSNode.tsx          # WBSノードコンポーネント
apps/web/src/components/wbs/WBSActions.tsx       # WBS操作コンポーネント
```

#### Gantt Components
```
apps/web/src/components/gantt/GanttChart.tsx     # ガントメインコンテナ
apps/web/src/components/gantt/GanttTimeline.tsx  # ガントタイムライン
apps/web/src/components/gantt/GanttGrid.tsx      # ガントグリッド
apps/web/src/components/gantt/GanttBar.tsx       # ガントタスクバー
```

#### State Management
```
apps/web/src/stores/wbs.store.ts                 # WBSストア
apps/web/src/stores/gantt.store.ts               # ガントストア
```

#### Pages
```
apps/web/src/app/wbs/page.tsx                    # WBSメインページ
apps/web/src/app/wbs/layout.tsx                  # WBSレイアウト
apps/web/src/app/gantt/page.tsx                  # ガントメインページ
apps/web/src/app/gantt/layout.tsx                # ガントレイアウト
```

#### Styling
```
apps/web/src/app/wbs/styles.css                  # WBS専用スタイル
apps/web/src/app/gantt/styles.css                # ガント専用スタイル
```

### 3.2 修正ファイル（6件）

#### Backend
```
apps/api/src/issues/issues.controller.ts         # WBS・ガント用エンドポイント追加
apps/api/src/issues/issues.service.ts            # 階層データ取得ロジック追加
```

#### Frontend
```
apps/web/src/app/layout.tsx                      # メインナビゲーション更新
apps/web/src/types/issue.ts                      # 階層関係フィールド追加
apps/web/package.json                            # D3.js関連依存関係追加
apps/web/src/lib/utils.ts                        # WBS・ガント共通ユーティリティ追加
```

### 3.3 依存関係追加
```json
{
  "dependencies": {
    "d3-scale": "^4.0.2",
    "d3-time": "^3.1.0", 
    "d3-array": "^3.2.4"
  },
  "devDependencies": {
    "@types/d3-scale": "^4.0.5",
    "@types/d3-time": "^3.0.1",
    "@types/d3-array": "^3.2.1"
  }
}
```

## 4. テスト戦略

### 4.1 単体テスト
**対象**: 個別コンポーネント・ユーティリティ関数  
**ツール**: Jest + React Testing Library

- **WBS Utilities**: 階層データ操作ロジック
- **Gantt Utilities**: D3スケール計算・時間操作
- **WBS Components**: ツリー展開・選択状態
- **Gantt Components**: タスクバー表示・時間軸計算

### 4.2 統合テスト
**対象**: コンポーネント間連携・状態管理  
**ツール**: Jest + MSW (Mock Service Worker)

- **WBS ↔ Issue詳細**: ノード選択時のデータ連携
- **ガント ↔ Issue詳細**: タスクバー選択時のデータ連携
- **API統合**: WBS・ガントデータの正常取得

### 4.3 E2Eテスト
**対象**: ユーザーワークフロー  
**ツール**: Playwright

- **WBS操作フロー**: ツリー展開→ノード選択→詳細表示
- **ガント操作フロー**: 時間軸切替→バー選択→詳細表示
- **画面遷移フロー**: Issue一覧→WBS→ガント→Issue詳細

### 4.4 パフォーマンステスト
**対象**: 大量データ表示性能  
**目標**: 1,000 Issue < 1.5秒

- **WBSツリー**: 1,000ノード展開時間
- **ガント描画**: 1,000バー初回描画時間
- **メモリ使用量**: 長時間使用時のメモリリーク

## 5. リスク分析と対策

### 5.1 技術リスク

#### 🟡 中リスク: D3.js統合の複雑性
**リスク内容**: D3スケールとReactコンポーネントの統合が複雑
**発生確率**: 30% | **影響度**: 中  
**対策**:
- D3はスケール計算のみに限定、DOM操作はReactに委譲
- 既存のD3-Reactパターン（useEffect + useRef）採用
- 段階的実装（スケールのみ→描画→インタラクション）

#### 🟡 中リスク: 1,000件データの表示性能
**リスク内容**: 大量Issue表示時の性能劣化  
**発生確率**: 40% | **影響度**: 高  
**対策**:
- react-virtualized による仮想スクロール実装
- React.memo による不要レンダリング防止
- サーバーサイドページネーション併用

#### 🟢 低リスク: WBS階層データの複雑性
**リスク内容**: 深い階層・循環参照の処理  
**発生確率**: 20% | **影響度**: 低  
**対策**:
- 既存のIssue API に循環参照検出機能あり
- 階層深度制限（最大10レベル）
- フロントエンド側での再帰処理制限

### 5.2 スケジュールリスク

#### 🟡 中リスク: ガント表示の実装遅延
**リスク内容**: SVG描画とD3統合で予想以上の時間を要する  
**発生確率**: 35% | **影響度**: 中  
**対策**:
- 段階的実装（静的表示→動的更新→インタラクション）
- 最小機能での先行リリース
- 複雑な機能のWeek 3への延期

#### 🟢 低リスク: API拡張の遅延
**リスク内容**: Backend API拡張に想定より時間がかかる  
**発生確率**: 15% | **影響度**: 低  
**対策**:
- 既存Issue APIの活用（大幅な改修不要）
- モックデータでのフロントエンド先行開発
- 段階的API拡張

### 5.3 品質リスク

#### 🟢 低リスク: 型安全性の低下
**リスク内容**: D3.js統合で型安全性が低下  
**発生確率**: 25% | **影響度**: 中  
**対策**:
- 厳密な型定義作成（WBS・ガント・D3型）
- TypeScript strict mode維持
- 型チェック自動化（CI/CD統合）

## 6. 成功指標とKPI

### 6.1 機能KPI
- **WBS表示成功率**: 99.5%以上
- **ガント初回描画成功率**: 99%以上  
- **Issue詳細連携成功率**: 99.5%以上

### 6.2 性能KPI
- **1,000 Issue WBS表示**: < 1.2秒
- **1,000 Issue ガント描画**: < 1.5秒
- **メニュー遷移**: < 200ms

### 6.3 品質KPI
- **TypeScript型エラー**: 0件
- **ESLint警告**: 0件
- **単体テストカバレッジ**: 80%以上

## 7. 実装順序とマイルストーン

### 📅 Milestone 1: 基盤準備 (25%)
**期間**: Day 1-2  
**成果物**:
- ✅ 型定義完了（WBS・ガント）
- ✅ D3.js依存関係追加
- ✅ ユーティリティ関数基盤

### 📅 Milestone 2: API拡張 (50%)  
**期間**: Day 3-4  
**成果物**:
- ✅ Issue API拡張（/tree, /gantt エンドポイント）
- ✅ WBS階層データ取得機能
- ✅ パフォーマンス最適化

### 📅 Milestone 3: WBS実装 (75%)
**期間**: Day 5-6  
**成果物**:
- ✅ WBSツリーコンポーネント完成
- ✅ WBSページ・ナビゲーション
- ✅ Issue詳細連携

### 📅 Milestone 4: ガント実装 (100%)
**期間**: Day 7-8  
**成果物**:
- ✅ ガントチャート基本表示
- ✅ D3スケール統合
- ✅ 統合テスト・最適化

## 8. 後続計画への接続

### 8.1 Week 3 準備事項
- **ドラッグ&ドロップ基盤**: React DnDライブラリ検討
- **Undo/Redo設計**: 状態管理パターンの設計
- **FS依存関係表示**: グラフィカル表現の仕様

### 8.2 技術負債管理
- D3.js統合パターンの文書化
- パフォーマンス最適化手法の標準化
- コンポーネント設計パターンの整理

## 9. 承認・実行準備

### 9.1 事前確認事項
✅ **技術的準備**
- Week 1実装（Issue CRUD）完了確認
- 開発環境の動作確認
- 依存関係競合チェック

✅ **リソース準備**
- 実装期間確保（8日間）
- テストデータ準備（1,000件Issue）
- 段階的デプロイ環境準備

### 9.2 実装開始条件
- [x] プラン承認完了
- [ ] 実装環境準備完了
- [ ] 必要リソース確保完了

---

## 📋 総括

**実装推奨**: Week 2 (WBS階層表示 + ガント初期表示) は技術的実現可能性が高く、Week 1の基盤を活用した段階的拡張が可能です。

**重要な成功要因**:
1. **段階的実装**: 基盤→API→WBS→ガントの順序
2. **性能重視**: 1,000件データでの応答性確保
3. **型安全性**: TypeScript厳密設定の維持

実装準備が整い次第、すぐに開始可能な状態です。