# Sprint 3実装計画書

**計画策定日**: 2025-09-05 03:56:53  
**対象**: GanttChartWebUI プロジェクト Sprint 3実装  
**ベース**: 調査レポート investigate_20250905_034851.md

---

## 1. 実装方針・目標

### 1.1 実装方針
- **段階的実装**: リスク最小化のため機能別に段階的実装
- **品質重視**: 各機能の受入基準を明確化し、テスト駆動開発
- **性能優先**: PoC受入基準（初回描画<1.5s、ドラッグ応答<100ms）達成を最優先

### 1.2 Sprint 3の目標
1. **プロジェクトパスワード保護機能**の完全実装
2. **性能テレメトリ基盤**の構築と測定開始
3. **進捗管理機能**の直接編集対応
4. **PoC受入基準**の部分的達成

### 1.3 成功指標
- プロジェクトパスワード保護による閲覧制限機能の動作
- 性能指標の客観的測定開始（1.5s/100ms基準での評価）
- 進捗更新のユーザビリティ向上

---

## 2. 詳細実装タスク分解

### 2.1 Phase 1: プロジェクトパスワード保護機能（優先度: 最高）

#### タスク1.1: データベース基盤実装（2日）
- **T1.1.1**: Prismaスキーマ拡張
  - Project model に `visibility`, `password_hash` フィールド追加
  - マイグレーションファイル作成
- **T1.1.2**: シードデータ更新
  - デフォルトプロジェクトに visibility 設定

#### タスク1.2: Backend API実装（3日）
- **T1.2.1**: Project基本CRUD API
  - Projects module/controller/service 作成
  - Project entity/DTO定義
- **T1.2.2**: パスワード認証API
  - PUT /projects/:id/password（パスワード設定）
  - POST /projects/:id/access（パスワード認証）
  - Argon2id ハッシュ化実装
- **T1.2.3**: アクセス制御機能
  - Project access guard実装
  - 試行制限（5回/15分）実装

#### タスク1.3: Frontend実装（3日）
- **T1.3.1**: プロジェクト状態管理
  - Projects store実装
  - Project types定義
- **T1.3.2**: プロジェクト選択UI
  - ProjectSelector component実装
  - Header integration
- **T1.3.3**: パスワード認証UI
  - ProjectPasswordModal実装
  - トークン管理（24時間有効）

### 2.2 Phase 2: 性能最適化・テレメトリ（優先度: 高）

#### タスク2.1: テレメトリ基盤実装（2日）
- **T2.1.1**: Performance metrics定義
  - GanttPerformanceMetrics interface
  - 計測ポイント定義
- **T2.1.2**: 計測フック実装
  - usePerformanceMetrics hook
  - メトリクス収集ロジック

#### タスク2.2: 性能最適化実装（2日）  
- **T2.2.1**: Ganttチャート最適化
  - 初回描画時間計測・最適化
  - SVG描画の差分更新
- **T2.2.2**: インタラクション最適化
  - ドラッグ応答時間計測・最適化
  - イベントデバウンス強化

### 2.3 Phase 3: 進捗管理強化（優先度: 中）

#### タスク3.1: 進捗編集機能（2日）
- **T3.1.1**: WBSNode進捗編集
  - 直接編集UI実装
  - リーフノード制限ロジック
- **T3.1.2**: 進捗集計強化
  - 親ノード自動集計改善
  - 工数ベース進捗計算

---

## 3. ファイル変更計画

### 3.1 新規作成ファイル

#### Backend (apps/api/src/)
```
projects/
├── projects.module.ts              # Projects module定義
├── projects.controller.ts          # Project CRUD + 認証API
├── projects.service.ts             # ビジネスロジック・セキュリティ
├── dto/
│   ├── create-project.dto.ts       # プロジェクト作成DTO
│   ├── update-project.dto.ts       # プロジェクト更新DTO
│   └── project-access.dto.ts       # パスワード認証DTO
└── entities/
    └── project.entity.ts           # Project entity定義

auth/guards/
└── project-access.guard.ts         # プロジェクトアクセス制御
```

#### Frontend (apps/web/src/)
```
stores/
└── projects.store.ts               # プロジェクト状態管理

types/
└── project.ts                      # Project型定義

components/projects/
├── ProjectSelector.tsx             # プロジェクト選択UI
├── ProjectPasswordModal.tsx        # パスワード入力モーダル
└── CreateProjectModal.tsx          # プロジェクト作成モーダル

lib/
└── performance.ts                  # パフォーマンス測定ユーティリティ

hooks/
└── usePerformanceMetrics.ts        # パフォーマンス測定フック

app/projects/
└── page.tsx                        # プロジェクト管理ページ
```

#### Database
```
prisma/migrations/
└── 20250905000000_add_project_visibility/
    └── migration.sql               # Project table拡張
```

### 3.2 修正対象ファイル

#### Backend修正
```
prisma/schema.prisma                # Project model拡張
apps/api/src/app.module.ts          # ProjectsModule追加
scripts/seed.ts                     # プロジェクト初期データ対応
```

#### Frontend修正  
```
apps/web/src/app/layout.tsx         # プロジェクトコンテキスト追加
apps/web/src/components/navigation/Header.tsx  # プロジェクト選択UI統合
apps/web/src/components/wbs/WBSNode.tsx        # 進捗直接編集機能
apps/web/src/components/gantt/GanttChart.tsx   # パフォーマンス測定追加
apps/web/src/components/wbs/WBSTree.tsx        # パフォーマンス測定追加
apps/web/src/stores/wbs.store.ts               # 進捗更新ロジック
```

---

## 4. テスト戦略

### 4.1 エンドポイントテスト（必須）
**対象**: 新規Project API
```typescript
// テスト対象エンドポイント
POST   /api/v1/projects                    # プロジェクト作成
GET    /api/v1/projects                    # プロジェクト一覧
PUT    /api/v1/projects/:id                # プロジェクト更新
PUT    /api/v1/projects/:id/password       # パスワード設定
POST   /api/v1/projects/:id/access         # パスワード認証
```

**テスト項目**:
- 正常系: CRUD操作、パスワード認証成功
- 異常系: 認証失敗、試行制限、無効なパラメータ
- セキュリティ: Argon2idハッシュ化、SQLインジェクション対策

### 4.2 パフォーマンステスト（必須）
**対象**: PoC受入基準達成確認
```typescript
// 測定項目
- 初回描画時間: < 1.5秒（1,000 Issue環境）
- ドラッグ応答: < 100ms
- ズーム操作: < 150ms
- メモリ使用量: 監視・上限設定
```

**テスト環境**:
- 1,000 Issue シードデータ使用
- Chrome DevTools Performance測定
- 自動化テストでの継続監視

### 4.3 E2Eテスト（実施）
**対象**: プロジェクト管理フロー
```gherkin
Scenario: プロジェクトパスワード認証
  Given ユーザーがログインしている
  When パスワード保護プロジェクトを選択する
  And 正しいパスワードを入力する
  Then プロジェクトにアクセスできる
  And 24時間アクセス権限が付与される

Scenario: 進捗直接編集
  Given WBS画面を開いている
  When リーフノードの進捗をクリックする
  Then 進捗入力フィールドが表示される
  When 進捗値を更新する
  Then 親ノードの進捗が自動更新される
```

**実装**: Playwright使用、主要シナリオ3本

### 4.4 単体テスト（重要機能のみ）
**対象**:
- Argon2idハッシュ化関数
- 試行制限ロジック
- 進捗集計アルゴリズム
- パフォーマンス測定フック

**実装**: Jest使用、カバレッジ80%以上

### 4.5 統合テスト（認証フロー）
**対象**: 
- JWT認証との統合
- プロジェクトアクセス制御
- Prisma ORM統合

**実装**: テスト用DB使用、トランザクション管理

---

## 5. リスク分析・対策

### 5.1 高リスク項目

#### R1: 性能要件未達（発生確率: 中、影響度: 高）
- **リスク**: 1,000 Issue環境で性能基準未達成
- **影響**: PoC受入基準不合格
- **対策**:
  - 早期ベンチマーク実施（T2.1完了後すぐ）
  - 段階的最適化（描画→イベント→データ取得）
  - 緊急時フォールバック: データ量制限（500 Issue）

#### R2: 認証フロー複雑化（発生確率: 低、影響度: 中）  
- **リスク**: パスワード認証がユーザビリティを悪化
- **影響**: ユーザー体験低下
- **対策**:
  - シンプルなUI設計（1画面完結）
  - 十分なE2Eテスト実施
  - ユーザビリティテスト（内部評価）

### 5.2 中リスク項目

#### R3: 既存機能への影響（発生確率: 低、影響度: 中）
- **リスク**: プロジェクト概念導入でIssue/WBS機能に影響
- **影響**: 回帰バグ発生
- **対策**:
  - 漸進的統合（既存API互換性維持）
  - 包括的回帰テスト
  - フィーチャーフラグ活用

### 5.3 低リスク項目

#### R4: セキュリティ脆弱性（発生確率: 低、影響度: 高）
- **対策**: Argon2id使用、セキュリティテスト徹底

---

## 6. 技術アーキテクチャ詳細

### 6.1 データベース設計

#### Project Model拡張
```sql
-- Migration: 20250905000000_add_project_visibility
ALTER TABLE "Project" ADD COLUMN "visibility" TEXT NOT NULL DEFAULT 'private';
ALTER TABLE "Project" ADD COLUMN "password_hash" TEXT;

-- Index for performance
CREATE INDEX "Project_visibility_idx" ON "Project"("visibility");
```

#### Prisma Schema更新
```prisma
model Project {
  id           String   @id @default(uuid())
  name         String
  visibility   String   @default("private") // 'private'|'password'|'public'
  passwordHash String?  @map("password_hash")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  issues       Issue[]
  dependencies Dependency[]
  calendars    Calendar[]
  activityLogs ActivityLog[]
  
  @@index([visibility])
}
```

### 6.2 セキュリティ実装

#### パスワードハッシュ化
```typescript
// projects.service.ts
import * as argon2 from 'argon2';

async hashPassword(password: string): Promise<string> {
  return argon2.hash(password, {
    type: argon2.argon2id,
    memoryCost: 32768,    // 32MB
    timeCost: 3,          // 3 iterations
    parallelism: 1,
  });
}

async verifyPassword(password: string, hash: string): Promise<boolean> {
  return argon2.verify(hash, password);
}
```

#### 試行制限実装
```typescript
// Rate limiting: Memory-based (Redis for production)
private readonly attemptTracker = new Map<string, {count: number, resetAt: number}>();
private readonly MAX_ATTEMPTS = 5;
private readonly WINDOW_MS = 15 * 60 * 1000; // 15 minutes

checkRateLimit(clientId: string): boolean {
  const now = Date.now();
  const attempts = this.attemptTracker.get(clientId);
  
  if (!attempts || now > attempts.resetAt) {
    this.attemptTracker.set(clientId, {count: 1, resetAt: now + this.WINDOW_MS});
    return true;
  }
  
  if (attempts.count >= this.MAX_ATTEMPTS) {
    return false;
  }
  
  attempts.count++;
  return true;
}
```

### 6.3 Performance Metrics実装

#### メトリクス定義
```typescript
// performance.ts
export interface GanttPerformanceMetrics {
  initialRenderTime: number;      // 初回描画時間
  dragResponseTime: number;       // ドラッグ応答時間
  zoomTransitionTime: number;     // ズーム切替時間  
  memoryUsage: number;           // メモリ使用量
  taskCount: number;             // 描画タスク数
  dependencyCount: number;       // 依存関係数
  timestamp: number;             // 測定時刻
}

export class PerformanceMonitor {
  private metrics: GanttPerformanceMetrics[] = [];
  
  measureInitialRender<T>(renderFn: () => T): T {
    const start = performance.now();
    const result = renderFn();
    const duration = performance.now() - start;
    
    this.addMetric('initialRenderTime', duration);
    return result;
  }
  
  measureDragResponse<T>(dragFn: () => T): T {
    const start = performance.now();
    const result = dragFn();
    const duration = performance.now() - start;
    
    this.addMetric('dragResponseTime', duration);
    return result;
  }
  
  getAverageRenderTime(): number {
    const renderTimes = this.metrics.map(m => m.initialRenderTime).filter(Boolean);
    return renderTimes.reduce((a, b) => a + b, 0) / renderTimes.length || 0;
  }
  
  isPerformanceAcceptable(): boolean {
    const avgRenderTime = this.getAverageRenderTime();
    const avgDragTime = this.getAverageDragTime();
    
    return avgRenderTime < 1500 && avgDragTime < 100; // 1.5s and 100ms limits
  }
}
```

### 6.4 State Management設計

#### Projects Store
```typescript
// projects.store.ts
interface ProjectsState {
  projects: Project[];
  currentProject: Project | null;
  accessTokens: Map<string, {token: string, expiresAt: number}>;
  loading: boolean;
  error?: string;
}

interface ProjectsActions {
  fetchProjects: () => Promise<void>;
  selectProject: (projectId: string, password?: string) => Promise<void>;
  createProject: (data: CreateProjectData) => Promise<void>;
  updateProject: (projectId: string, data: UpdateProjectData) => Promise<void>;
  setProjectPassword: (projectId: string, password: string) => Promise<void>;
  checkProjectAccess: (projectId: string) => boolean;
  clearAccessToken: (projectId: string) => void;
}

export const useProjectsStore = create<ProjectsState & ProjectsActions>()((set, get) => ({
  // State initialization
  projects: [],
  currentProject: null,
  accessTokens: new Map(),
  loading: false,
  
  // Actions implementation
  selectProject: async (projectId: string, password?: string) => {
    const project = get().projects.find(p => p.id === projectId);
    if (!project) return;
    
    if (project.visibility === 'password' && !get().checkProjectAccess(projectId)) {
      if (!password) {
        throw new Error('Password required');
      }
      
      // Authenticate and get access token
      const response = await fetch(`/api/v1/projects/${projectId}/access`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({password})
      });
      
      if (!response.ok) {
        throw new Error('Invalid password');
      }
      
      const {accessToken, expiresAt} = await response.json();
      get().accessTokens.set(projectId, {token: accessToken, expiresAt});
    }
    
    set({currentProject: project});
  },
  
  checkProjectAccess: (projectId: string) => {
    const tokenInfo = get().accessTokens.get(projectId);
    return tokenInfo && tokenInfo.expiresAt > Date.now();
  }
}));
```

---

## 7. 実装スケジュール

### 7.1 Phase別スケジュール（総工期: 9日）

#### Week 1 (Day 1-5): Phase 1 - プロジェクトパスワード保護
- **Day 1**: データベース設計・マイグレーション
- **Day 2**: Backend API実装（CRUD）
- **Day 3**: Backend認証・セキュリティ実装
- **Day 4**: Frontend状態管理・UI実装
- **Day 5**:統合テスト・E2Eテスト

#### Week 2 (Day 6-9): Phase 2&3 - 性能最適化・進捗管理
- **Day 6**: パフォーマンステレメトリ実装
- **Day 7**: Gantt性能最適化・測定
- **Day 8**: 進捗管理強化実装
- **Day 9**: 統合テスト・受入テスト・リリース準備

### 7.2 マイルストーン

| マイルストーン | 完了日 | 達成基準 |
|---------------|--------|----------|
| **MS1: DB基盤完成** | Day 1 | Migration成功、Seed実行可能 |
| **MS2: API完成** | Day 3 | Endpoint Test全通過 |
| **MS3: UI完成** | Day 4 | E2E Test全通過 |
| **MS4: セキュリティ完成** | Day 5 | セキュリティテスト通過 |
| **MS5: 性能基盤完成** | Day 6 | メトリクス収集開始 |
| **MS6: 性能最適化完成** | Day 7 | 性能基準達成（1.5s/100ms） |
| **MS7: 進捗機能完成** | Day 8 | 進捗編集E2E通過 |
| **MS8: Sprint 3完成** | Day 9 | 受入基準全項目達成 |

### 7.3 並行作業計画

#### Backend Team (BE1, BE2)
- **BE1**: Projects API実装（Day 1-3）→ 性能最適化支援（Day 6-7）
- **BE2**: セキュリティ実装（Day 2-4）→ 進捗ロジック実装（Day 8）

#### Frontend Team (FE1, FE2)
- **FE1**: プロジェクト管理UI（Day 3-5）→ パフォーマンス測定（Day 6-7）  
- **FE2**: 状態管理実装（Day 3-4）→ 進捗UI実装（Day 8）

---

## 8. 受入基準・Definition of Done

### 8.1 Phase 1受入基準（プロジェクトパスワード保護）

#### 機能要件
- [ ] プロジェクト作成・更新ができる
- [ ] プロジェクトにパスワードを設定できる
- [ ] パスワード認証によりプロジェクトにアクセスできる
- [ ] 認証成功後24時間アクセス権が維持される
- [ ] パスワード試行制限（5回/15分）が動作する

#### 非機能要件
- [ ] Argon2idによるパスワードハッシュ化
- [ ] SQLインジェクション対策実施
- [ ] CSRF対策実施
- [ ] API応答時間 < 200ms（認証エンドポイント）

#### テスト要件
- [ ] エンドポイントテスト全通過（正常系・異常系）
- [ ] E2Eテスト通過（認証フロー）
- [ ] セキュリティテスト通過
- [ ] 単体テスト通過（セキュリティ関数）

### 8.2 Phase 2受入基準（性能最適化）

#### 性能要件
- [ ] **初回描画時間 < 1.5秒**（1,000 Issue環境）
- [ ] **ドラッグ応答時間 < 100ms**
- [ ] **ズーム切替時間 < 150ms**
- [ ] メモリリーク無し（長時間操作後）

#### 機能要件
- [ ] パフォーマンスメトリクス自動収集
- [ ] リアルタイム性能監視
- [ ] 性能異常の自動検出

#### テスト要件
- [ ] パフォーマンステスト全項目クリア
- [ ] 継続監視システム動作確認
- [ ] 負荷テスト実施（1,000 Issue + 300依存関係）

### 8.3 Phase 3受入基準（進捗管理）

#### 機能要件
- [ ] リーフノードの進捗を直接編集できる
- [ ] 親ノードの進捗が自動集計される
- [ ] 工数ベースの進捗計算が正しく動作する
- [ ] 進捗更新がリアルタイムでGanttに反映される

#### UX要件
- [ ] 進捗編集の操作が直感的
- [ ] 進捗変更の視覚フィードバック
- [ ] エラー処理・ユーザー通知

### 8.4 総合受入基準

#### 統合性
- [ ] 全機能が統合されて正常動作
- [ ] 既存機能（Issue/WBS/Gantt）への影響無し
- [ ] 認証フローが全画面で一貫

#### 運用性  
- [ ] ログ・監視が適切に動作
- [ ] エラーハンドリングが完備
- [ ] パフォーマンス監視が継続動作

---

## 9. リリース・デプロイ戦略

### 9.1 段階的リリース

#### Stage 1: Development Environment
- **対象**: 開発者テスト環境
- **目的**: 基本機能動作確認
- **期間**: Day 3-4（Phase 1完成後）

#### Stage 2: Staging Environment  
- **対象**: ステージング環境（本番同等）
- **目的**: 統合テスト・性能テスト
- **期間**: Day 7（Phase 2完成後）

#### Stage 3: PoC Environment
- **対象**: PoC評価環境
- **目的**: 受入テスト・ユーザビリティ確認
- **期間**: Day 9（全Phase完成後）

### 9.2 ロールバック戦略

#### データベース
- **対策**: Migration rollbackスクリプト準備
- **検証**: ロールバックテスト実施

#### アプリケーション
- **対策**: フィーチャーフラグによる即座な機能無効化
- **検証**: 緊急時対応手順書作成

---

## 10. 次フェーズ準備

### 10.1 Sprint 4準備項目

#### 技術的負債解消
- react-window型問題の根本解決
- TODO項目の優先順位付け・実装
- API レスポンス型統一

#### 機能拡張基盤
- Markdown編集サポート基盤
- 通知システム基盤
- エクスポート機能基盤

### 10.2 長期ロードマップ整合性

#### アーキテクチャ進化
- マイクロサービス分割準備
- キャッシュ戦略強化
- リアルタイム機能基盤

#### 運用・監視強化
- APM（Application Performance Monitoring）導入
- ビジネスメトリクス収集
- A/Bテスト基盤構築

---

## 11. 成果物・ドキュメント

### 11.1 開発成果物
- [ ] 動作するWebアプリケーション（全機能統合）
- [ ] 更新されたAPI仕様書
- [ ] パフォーマンステストレポート
- [ ] セキュリティテストレポート

### 11.2 運用ドキュメント
- [ ] プロジェクト管理操作手順書
- [ ] 性能監視運用手順書
- [ ] トラブルシューティングガイド
- [ ] 緊急時対応手順書

### 11.3 技術ドキュメント
- [ ] アーキテクチャ設計書（更新版）
- [ ] データベース設計書（更新版）
- [ ] API仕様書（OpenAPI 3.1）
- [ ] セキュリティ仕様書

---

## 12. 成功・失敗条件

### 12.1 成功条件
1. **機能完成度**: 全Phase受入基準达成率 ≥ 95%
2. **性能達成**: PoC性能要件（1.5s/100ms）達成
3. **品質確保**: テスト通過率 ≥ 90%（E2E, Unit, Integration）
4. **UX向上**: プロジェクト切替・進捗編集のユーザビリティ改善確認

### 12.2 失敗・警告条件
1. **性能未達**: 初回描画 > 2.0s または ドラッグ応答 > 150ms
2. **セキュリティ問題**: 脆弱性テストでHigh以上の検出
3. **回帰バグ**: 既存機能の重大な機能劣化
4. **スケジュール遅延**: 2日以上の遅延

### 12.3 緊急時対応
- **機能削減**: Phase 3（進捗管理）をSprint 4に延期
- **性能妥協**: 一時的に500 Issue制限で受入
- **UI簡素化**: パスワード機能を基本実装のみに限定

---

**Status**: SUCCESS  
**Next**: IMPLEMENT  
**Details**: "実装プラン策定完了。plan_20250905_035653.mdに詳細記録。実装フェーズに移行。"