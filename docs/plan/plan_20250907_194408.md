# 実装プラン: Issue Synchronization with Internal System

## 生成日時: 2025-09-07 19:44:08

---

## 1. プラン概要

### 実装目標
**Issue Synchronization with Internal System** - 外部Webhook経由で受信したイシュー情報を内部プロジェクト管理システムと同期する機能の実装

### 調査結果に基づく判断
- 調査報告書: `docs/investigate/investigate_20250907_093000.md`
- **推奨レベル**: 🔴 **HIGH PRIORITY**  
- **実装判断**: ✅ **IMPLEMENT** - アーキテクチャの完成とビジネス価値の提供

---

## 2. 実装方針

### 実装アプローチ
**段階的実装方式**: 4フェーズに分けて安全かつ確実に機能を構築

1. **Phase 1**: 基本的なイシュー作成同期 (webhook → 内部イシュー)
2. **Phase 2**: イシュー更新同期 (ステータス、担当者、説明変更)  
3. **Phase 3**: イシュー削除/クローズ同期とプロジェクトタイムライン更新
4. **Phase 4**: 双方向同期 (内部変更 → 外部webhook)

### 技術方針
- **既存インフラの活用**: 現在のWebhookシステム（`IntegrationsService`）を拡張
- **サービス分離**: 同期ロジックを専用サービス（`IssueSyncService`）として実装
- **エラーハンドリング強化**: 失敗時のリトライとフォールバック機能
- **設定ベース**: プロジェクトマッピング等は設定で柔軟に対応

---

## 3. 詳細実装タスク（優先度順）

### 🔴 **HIGH PRIORITY**

#### タスク 1: Issue Sync Service 基盤構築
- **ファイル**: `apps/api/src/integrations/services/issue-sync.service.ts` (新規作成)
- **内容**:
  - ユーザーメール→ID変換ロジック
  - ステータスマッピング（外部→内部）
  - プロジェクト関連付けロジック
  - 重複検出機能
- **工数**: 45分
- **受け入れ条件**: メール→ID変換、ステータス変換、プロジェクト関連付けが動作する

#### タスク 2: Webhook Event Handler拡張
- **ファイル**: `apps/api/src/integrations/integrations.service.ts` (修正)
- **内容**:
  - `handleIssueCreatedEvent`でTODOを実装→`IssueSyncService.syncCreatedIssue()`呼び出し
  - `handleIssueUpdatedEvent`でTODOを実装→`IssueSyncService.syncUpdatedIssue()`呼び出し  
  - `handleIssueClosedEvent`でTODOを実装→`IssueSyncService.syncClosedIssue()`呼び出し
- **工数**: 30分
- **受け入れ条件**: 全てのイベントハンドラーでIssueSyncServiceが正常に呼び出される

#### タスク 3: 同期設定インターフェース
- **ファイル**: `apps/api/src/integrations/dto/sync-config.dto.ts` (新規作成)
- **内容**:
  - プロジェクトマッピング設定DTO
  - ステータスマッピング設定DTO  
  - 同期オプション設定DTO
- **工数**: 20分
- **受け入れ条件**: 設定DTOが定義され、バリデーションが動作する

### 🟡 **MEDIUM PRIORITY**

#### タスク 4: エラーハンドリング強化
- **ファイル**: `apps/api/src/integrations/services/issue-sync.service.ts` (修正)
- **内容**:
  - ユーザー未存在時のフォールバック処理
  - 未知ステータスのデフォルト処理
  - プロジェクト関連付け失敗時の処理
- **工数**: 25分
- **受け入れ条件**: エラーケースで適切なフォールバックとログ出力がされる

---

## 4. ファイル変更計画

### 新規作成ファイル

| ファイルパス | 目的 | 主要機能 |
|-------------|------|---------|
| `apps/api/src/integrations/services/issue-sync.service.ts` | Issue同期メインロジック | ユーザー変換、ステータス変換、同期実行 |
| `apps/api/src/integrations/dto/sync-config.dto.ts` | 同期設定DTO | プロジェクトマッピング、ステータス変換設定 |
| `apps/api/src/integrations/interfaces/issue-sync.interface.ts` | 同期関連インターフェース | 同期結果、エラー情報の型定義 |

### 修正ファイル

| ファイルパス | 修正内容 | 影響範囲 |
|-------------|---------|---------|
| `apps/api/src/integrations/integrations.service.ts` | TODO実装→IssueSyncService呼び出し | 3つのイベントハンドラーメソッド |
| `apps/api/src/integrations/integrations.module.ts` | IssueSyncService のDI設定追加 | モジュール設定のみ |

### 影響なしファイル

- `apps/api/src/issues/issues.service.ts` - 既存APIをそのまま利用
- `apps/api/src/projects/projects.service.ts` - 既存APIをそのまま利用
- Webhook DTO類 - 変更不要（既存構造で対応可能）

---

## 5. テスト戦略

### 単体テスト
- **対象**: `IssueSyncService`
- **テストケース**:
  - ✅ 正常ケース: 有効なWebhookデータ→内部イシュー作成成功
  - ⚠️ エラーケース1: ユーザーメール未存在→デフォルトユーザー設定
  - ⚠️ エラーケース2: 未知ステータス→'todo'ステータス設定
  - ⚠️ エラーケース3: プロジェクト関連付け失敗→エラー処理
- **ツール**: Jest + TypeScript
- **カバレッジ目標**: 85%以上

### 統合テスト  
- **対象**: `IntegrationsService` + `IssueSyncService` + `IssuesService`
- **テストケース**:
  - Webhook受信→Issue同期→DB保存の全フロー
  - 複数イベント連続処理（作成→更新→クローズ）
  - 同一イシューの重複処理（冪等性確認）

### エンドポイントテスト
- **対象**: `/api/integrations/webhook` エンドポイント
- **テストケース**:
  - GitLabからのWebhook受信→Issue同期実行
  - GitHubからのWebhook受信→Issue同期実行
  - 無効なWebhookデータ→適切なエラー処理

---

## 6. リスク分析と対策

### 🔴 **HIGH RISK**

#### リスク1: ユーザーメール→ID変換の失敗
- **影響**: 外部ユーザーが内部システムに存在しない場合の処理失敗
- **対策**: 
  - デフォルト「システムユーザー」の設定
  - メール→ユーザー作成の自動化オプション（Phase 2で検討）
- **回避策**: 設定でフォールバックユーザーIDを指定可能にする

#### リスク2: プロジェクト関連付けの曖昧さ
- **影響**: 外部イシューがどの内部プロジェクトに属するか不明
- **対策**:
  - Webhook送信元別のプロジェクトマッピング設定
  - リポジトリ名→プロジェクトIDの変換テーブル
- **回避策**: 設定ファイルまたは環境変数でのマッピング定義

### 🟡 **MEDIUM RISK**

#### リスク3: 同期処理のパフォーマンス影響
- **影響**: 大量Webhook受信時のAPI応答遅延
- **対策**: 
  - 同期処理の非同期化（キュー使用）
  - バッチ処理での効率化
- **回避策**: Webhook応答とIsue同期を分離（Phase 2で検討）

#### リスク4: データ整合性の問題
- **影響**: 同期失敗時の外部・内部データの不整合
- **対策**:
  - 同期状態の管理テーブル追加
  - 失敗時のリトライ機構
- **回避策**: 手動同期機能の提供

### 🟢 **LOW RISK**

#### リスク5: 既存機能への影響
- **影響**: Webhookシステムの既存機能への悪影響
- **対策**: 既存コードへの最小限の変更、後方互換性の維持
- **評価**: 既存のWebhookインフラは堅牢でテスト済み

---

## 7. 実装詳細設計

### Issue Sync Service アーキテクチャ

```typescript
interface IssueSyncService {
  // Phase 1: 基本同期機能
  syncCreatedIssue(webhookEvent: WebhookEvent): Promise<SyncResult>
  syncUpdatedIssue(webhookEvent: WebhookEvent): Promise<SyncResult>  
  syncClosedIssue(webhookEvent: WebhookEvent): Promise<SyncResult>
  
  // 変換・マッピング機能
  mapExternalUserToInternal(email: string): Promise<string | null>
  mapExternalStatusToInternal(status: string): IssueStatus
  resolveProjectForWebhook(webhook: WebhookEvent): Promise<string>
}
```

### データフロー設計

```
Webhook受信 → IntegrationsService.processWebhookEvent()
              ↓
           event typeに基づいてハンドラー選択
              ↓
        IssueSyncService.syncXxxIssue()
              ↓
    [ユーザー変換] → [ステータス変換] → [プロジェクト解決]
              ↓
        IssuesService.create/update/remove()
              ↓
            DB反映 + 結果返却
```

### 設定ファイル構造

```typescript
interface SyncConfiguration {
  projectMapping: {
    [repositoryName: string]: string; // repo名→projectId
  };
  statusMapping: {
    [externalStatus: string]: IssueStatus;
  };
  defaultOptions: {
    fallbackUserId: string;
    defaultStatus: IssueStatus;
    enableAutoUserCreation: boolean;
  };
}
```

---

## 8. 受け入れ条件

### Phase 1 完了条件

✅ **必須条件**:
1. GitLabからのissue.createdイベント受信→内部Issue作成成功
2. GitHubからのissue.updatedイベント受信→内部Issue更新成功  
3. 外部ユーザーメール→内部ユーザーID変換動作
4. 外部ステータス→内部ステータス変換動作
5. プロジェクト関連付けが設定通り動作
6. エラーケースで適切なログ出力とフォールバック処理実行

🎯 **成功指標**:
- Webhook受信から内部Issue作成まで3秒以内
- ユーザー変換失敗時にデフォルトユーザー設定成功  
- 未知ステータスに対してデフォルト'todo'設定成功
- 同期失敗時にエラーログと原因情報を出力

---

## 9. 実装スケジュール

| Phase | タスク | 工数 | 累積時間 |
|-------|--------|------|----------|
| **Setup** | プロジェクト分析・設計 | 30分 | 30分 |
| **Phase 1** | Issue Sync Service基盤 | 45分 | 1時間15分 |
| **Phase 1** | Webhook Handler拡張 | 30分 | 1時間45分 |
| **Phase 1** | 設定インターフェース | 20分 | 2時間5分 |
| **Phase 2** | エラーハンドリング強化 | 25分 | 2時間30分 |
| **Testing** | 単体・統合テスト | 30分 | 3時間 |

**総予定工数**: **3時間** (調査予測の2-3時間範囲内)

---

## 10. 次ステップ・将来拡張

### Phase 2拡張計画 (今回対象外)
- **双方向同期**: 内部Issue変更→外部システムAPI呼び出し
- **バッチ同期**: 過去データの一括同期機能
- **同期状態管理**: 同期履歴とステータス管理UI

### Phase 3拡張計画 (今回対象外)  
- **高度なマッピング**: ラベル、優先度、担当者チーム等の同期
- **コンフリクト解決**: 同時編集時の競合状態解決機能
- **パフォーマンス最適化**: キュー処理、バルク操作対応

---

## 11. プラン承認・実行

### 実装準備完了チェック

✅ **技術的準備**:
- [x] 既存Webhookインフラの理解完了
- [x] IssuesService / ProjectsService API確認完了  
- [x] データベーススキーマ（User, Project, Issue）確認完了
- [x] 依存関係とモジュール構成把握完了

✅ **設計準備**:
- [x] 実装方針の策定完了
- [x] ファイル変更計画の作成完了
- [x] リスク分析と対策の検討完了
- [x] テスト戦略の策定完了

### 実装フェーズ移行判定

**判定結果**: ✅ **実装準備完了**

**根拠**:
1. 調査で特定された明確な技術的ギャップ（TODO実装）
2. 既存アーキテクチャとの互換性確認済み
3. 段階的実装によるリスク最小化
4. 適切な工数見積もりと受け入れ条件の設定
5. 包括的なテスト戦略の策定

---

## プラン策定結果

**status**: ✅ **SUCCESS**  
**next**: 🚀 **IMPLEMENT**  
**details**: Issue Synchronization機能の実装プラン策定完了。plan_20250907_194408.mdに詳細記録。IMPLEMENTフェーズに移行準備完了。

---

*Generated by Claude Code Assistant - Planning Agent*  
*Project: GanttChartWebUI - Implementation Planning*  
*調査ベース: investigate_20250907_093000.md*